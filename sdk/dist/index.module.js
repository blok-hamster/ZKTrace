import*as e from"fs";import{readFileSync as t}from"fs";import{resolve as n,dirname as r}from"path";import{initialize as i}from"zokrates-js";import o from"keccak256";import{ethers as s}from"ethers";import a from"seedrandom";import u from"isomorphic-unfetch";import{Web3Storage as c}from"web3.storage";import{CarReader as l}from"@ipld/car/reader";import{Readable as p}from"readable-stream";import*as y from"multiformats/block";import{sha256 as d}from"multiformats/hashes/sha2";import*as m from"multiformats/codecs/raw";import*as f from"@ipld/dag-json";import*as h from"@ipld/dag-cbor";import{CarWriter as v}from"@ipld/car/writer";import{MerkleTree as g}from"merkletreejs";import b from"crypto-js";import P from"axios";import{customAlphabet as T}from"nanoid";class w{constructor(e){const t=this;this.nodeEndpoint=void 0,this.web3storageApiKey=void 0,this.factoryAddress=void 0,this.apikey=void 0,this.baseUrl=void 0,this.traceHubAddress=void 0,this.getFeeData=function(){try{return Promise.resolve(function(e,n){try{var r=Promise.resolve(t.getProvider()).then(function(e){return Promise.resolve(e.getFeeData()).then(function(e){return{maxFeePerGas:e.maxFeePerGas,maxPriorityFeePerGas:e.maxPriorityFeePerGas,gasLimit:5e6}})})}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}(0,function(e){throw console.log(e.message),new Error("Error Getting Fee Data")}))}catch(e){return Promise.reject(e)}},this.nodeEndpoint=e.nodeEndpoint,this.baseUrl=e.baseUri,this.apikey=e.apikey,this.web3storageApiKey=e.web3storageApiKey,this.factoryAddress=e.factoryAddress,this.traceHubAddress=e.traceHubAddress}invoke(e,t){try{const n=`${this.baseUrl}${e}`,r={...t,headers:{"content-type":"application/json",apiKey:this.apikey}};return u(n,r).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}catch(e){console.log(e.message)}}getWeb3StorageKey(){return this.web3storageApiKey}getProvider(){try{return Promise.resolve(new s.providers.JsonRpcProvider(this.nodeEndpoint))}catch(e){return Promise.reject(e)}}getFactoryAddress(){return this.factoryAddress}getTraceHubAddress(){return this.traceHubAddress}}function A(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}const k="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function M(e,t,n){if(!e.s){if(n instanceof S){if(!n.s)return void(n.o=M.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(M.bind(null,e,t),M.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}const S=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,i=this.s;if(i){const e=1&i?t:n;if(e){try{M(r,1,e(this.v))}catch(e){M(r,2,e)}return r}return this}return this.o=function(e){try{const i=e.v;1&e.s?M(r,1,t?t(i):i):n?M(r,1,n(i)):M(r,2,i)}catch(e){M(r,2,e)}},r},e}();function x(e){return e instanceof S&&1&e.s}function E(e,t,n){if("function"==typeof e[k]){var r,i,o,s=e[k]();if(function e(a){try{for(;!((r=s.next()).done||n&&n());)if((a=t(r.value))&&a.then){if(!x(a))return void a.then(e,o||(o=M.bind(null,i=new S,2)));a=a.v}i?M(i,1,a):i=a}catch(e){M(i||(i=new S),2,e)}}(),s.return){var a=function(e){try{r.done||s.return()}catch(e){}return e};if(i&&i.then)return i.then(a,function(e){throw a(e)});a()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,n){var r,i,o=-1;return function s(a){try{for(;++o<e.length&&(!n||!n());)if((a=t(o))&&a.then){if(!x(a))return void a.then(s,i||(i=M.bind(null,r=new S,2)));a=a.v}r?M(r,1,a):r=a}catch(e){M(r||(r=new S),2,e)}}(),r}(u,function(e){return t(u[e])},n)}const j="undefined"!=typeof Symbol?Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")):"@@asyncIterator";class D extends w{constructor(){super(...arguments);const t=this,n=this,r=this,i=this,s=this,a=this,u=this,b=this;this.initilizeWeb3Storage=function(){try{try{const e=new c({token:b.getWeb3StorageKey()});return Promise.resolve(e)}catch(e){throw console.error(e),new Error("Failed to initilize web3Storage")}}catch(e){return Promise.reject(e)}},this.uploadCarToIPFS=function(t){try{return Promise.resolve(A(function(){return Promise.resolve(u.initilizeWeb3Storage()).then(function(n){const r=e.createReadStream(`./cars/${t}.car`);return Promise.resolve(l.fromIterable(r)).then(function(r){return Promise.resolve(n.putCar(r,{name:`${t}.car`,decoders:[h]})).then(function(n){return e.unlinkSync(`./cars/${t}.car`),n})})})},function(e){throw console.error(e.message),new Error("Upload trace details failed")}))}catch(e){return Promise.reject(e)}},this.readData=function(e){try{let t;return Promise.resolve(A(function(){return Promise.resolve(P.get(`https://ipfs.io/api/v0/dag/get/${e}`).then(e=>{t=e.data.data}).catch(e=>{throw new Error(e.message)})).then(function(){return t})},function(e){throw console.error(e.message),new Error("read trace data failed")}))}catch(e){return Promise.reject(e)}},this.utf8Encoder=new TextEncoder,this.utf8Decoder=new TextDecoder,this.createBlock=function(e){try{const t=[];return Promise.resolve(A(function(){return Promise.resolve(y.encode({value:{data:e},hasher:d,codec:h})).then(function(e){return t.push(e),{blocks:t,roots:[e.cid]}})},function(e){throw console.error(e),new Error("IPLD block creation failed")}))}catch(e){return Promise.reject(e)}},this.write=function(t,n,r){try{return Promise.resolve(A(function(){e.existsSync("./cars")||e.mkdirSync("./cars");const{writer:i,out:o}=v.create(t);p.from(o).pipe(e.createWriteStream(`cars/${r}.car`));const s=E(n,function(e){return Promise.resolve(i.put(e)).then(function(){return Promise.resolve(i.close()).then(function(){})})});return s&&s.then?s.then(function(){return o}):o},function(e){throw console.error(e.message),new Error("Writing IPLD block failed")}))}catch(e){return Promise.reject(e)}},this.readCar=function(t){try{const n={[m.code]:m,[f.code]:f,[h.code]:h},r={[d.code]:d};return Promise.resolve(A(function(){const i=e.createReadStream(t);return Promise.resolve(l.fromIterable(i)).then(function(e){function t(){return{blockCid:s,data:o}}const i=[];let o,s;const u=function(e,t,n){if("function"==typeof e[j]){var r=new S,i=e[j]();return i.next().then(s).then(void 0,a),r;function o(e){if(n&&n())return M(r,1,i.return?i.return().then(function(){return e}):e);i.next().then(s).then(void 0,a)}function s(e){e.done?M(r,1):Promise.resolve(t(e.value)).then(o).then(void 0,a)}function a(e){M(r,2,i.return?i.return().then(function(){return e}):e)}}return Promise.resolve(E(e,function(e){return Promise.resolve(e).then(t)},n))}(e.blocks(),function(e){let{cid:t,bytes:u}=e;return Promise.resolve(y.create({cid:t,bytes:u,codec:n[t.code],hasher:r[t.multihash.code]})).then(function(e){i.push(e);const n=e.value instanceof Uint8Array?a.utf8Decoder.decode(e.value):e.value,r=JSON.parse(JSON.stringify(n.data));o=r,s=t.toString()})});return u&&u.then?u.then(t):t()})},function(e){throw console.error(e.message),new Error("Read Car File Failed")}))}catch(e){return Promise.reject(e)}},this.updatPreviousBlockCid=(e,t)=>{try{let n=e;return n.previousBlockCid=t,n}catch(e){throw console.error(e.message),new Error("Failed to update previous block ID")}},this.updateCar1=function(e,t,n){try{let r;return Promise.resolve(A(function(){const i=s.updatPreviousBlockCid(e,n);return Promise.resolve(s.createBlock(i)).then(function(e){let{blocks:n,roots:i}=e;return Promise.resolve(s.write(i,n,t)).then(function(){return Promise.resolve(s.uploadCarToIPFS(t)).then(function(e){return r=e,r})})})},function(e){throw console.error(e.message),new Error("Car File Update Failed")}))}catch(e){return Promise.reject(e)}},this.writeCar=function(e,t){try{let n;return Promise.resolve(A(function(){return Promise.resolve(i.createBlock(e)).then(function(e){let{blocks:r,roots:o}=e;return Promise.resolve(i.write(o,r,t)).then(function(){return Promise.resolve(i.uploadCarToIPFS(t)).then(function(e){return n=e,{message:"ok",cid:n}})})})},function(e){throw console.error(e.message),new Error("Error Creating Car File")}))}catch(e){return Promise.reject(e)}},this.buff2Hex=e=>"0x"+e.toString("hex"),this.getMerkelTree=function(e){try{try{const t=e.map(e=>r.buff2Hex(o(e))),n=new g(t,o,{sortPairs:!0}),i=r.buff2Hex(n.getRoot());return Promise.resolve({tree:n,root:i})}catch(e){throw console.error(e.message),new Error("getMerkelTree Failed")}}catch(e){return Promise.reject(e)}},this.getleave=e=>this.buff2Hex(o(e)),this.verifyMerkelProof=function(e,t,r){try{return Promise.resolve(A(function(){return Promise.resolve(n.getMerkelTree(r)).then(function(r){let{tree:i,root:o}=r;const s=n.getleave(t);return i.verify(e,s,o)})},function(e){throw console.error(e.message),new Error("merkel Proof Verification failed")}))}catch(e){return Promise.reject(e)}},this.createProof=function(e,n){try{return Promise.resolve(A(function(){const r=t.getleave(e);return Promise.resolve(t.getMerkelProof1(r,n))},function(e){throw console.error(e.message),new Error("Error Creating Proof")}))}catch(e){return Promise.reject(e)}}}readCid(e){try{return Promise.resolve(this.invoke(`storage/readData/${e}`))}catch(e){return Promise.reject(e)}}readCarData(e){try{return Promise.resolve(this.invoke(`storage/createCar/${e}`))}catch(e){return Promise.reject(e)}}createCar(e,t){try{return Promise.resolve(this.invoke(`storage/createCar/${t}`,{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}uploadCar(e){try{return Promise.resolve(this.invoke(`storage/uploadCar/${e}`,{method:"POST"}))}catch(e){return Promise.reject(e)}}updateCar(e,t){try{return Promise.resolve(this.invoke(`storage/createCar/${t}`,{method:"PUT",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}getMerkelProof(e,t){try{return Promise.resolve(this.invoke(`storage/getMerkelProof/${e}/${t}`,{method:"GET"}))}catch(e){return Promise.reject(e)}}getMerkelProof1(e,t){try{const n=this;return Promise.resolve(A(function(){return Promise.resolve(n.getMerkelTree(t)).then(function(t){let{tree:n}=t;return n.getHexProof(e)})},function(e){throw console.error(e.message),new Error("Failed to get merkel proof")}))}catch(e){return Promise.reject(e)}}encryptData(e,t){try{const n=b.AES.encrypt(JSON.stringify(e),t).toString();return Promise.resolve(n)}catch(e){return Promise.reject(e)}}decryptData(e,t){try{const n=this;return Promise.resolve(A(function(){return Promise.resolve(n.readData(e)).then(function(e){const n=b.AES.decrypt(e.encryptedData,t);return JSON.parse(n.toString(b.enc.Utf8))})},function(e){throw console.log(e.message),new Error("Error Decrypting Data")}))}catch(e){return Promise.reject(e)}}}function C(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}class I extends D{constructor(){super(...arguments),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}randomNumber(e){try{try{let t=[];for(let n=0;n<4;n++){const n=a(e,{entropy:!0});t.push(Math.abs(n.int32()).toString())}return Promise.resolve(t)}catch(e){console.error(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}getNullifier(e){try{try{const t=a(e,{entropy:!1});return Promise.resolve(Math.abs(t.int32()))}catch(e){console.error(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}fileSystemResolver(e,i){try{try{const o=n(r(n(e)),i),s=t(o).toString();return Promise.resolve(s)}catch(e){console.error(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}getSource(e,t){try{const n=this;return Promise.resolve(C(function(){return Promise.resolve(n.fileSystemResolver(e,t))},function(e){console.error(e)}))}catch(e){return Promise.reject(e)}}getZokrateProvider(){try{return Promise.resolve(C(i,function(e){console.error(e)}))}catch(e){return Promise.reject(e)}}getArtifacts(e){try{const t=this;return Promise.resolve(C(function(){return Promise.resolve(t.getZokrateProvider()).then(function(t){return t.compile(e)})},function(e){throw console.error(e.message),new Error("Error Getting Artifacts")}))}catch(e){return Promise.reject(e)}}getPreImage(e){try{const t=this;return Promise.resolve(C(function(){return Promise.resolve(t.randomNumber(e)).then(function(e){return Promise.resolve(t.getZokrateProvider()).then(function(n){return Promise.resolve(t.getSource("../circuit","sdk/circuit/preImage.zok")).then(function(r){return Promise.resolve(t.getArtifacts(r)).then(function(t){const{output:r}=n.computeWitness(t,e);return{params:e,preImage:JSON.parse(r)}})})})})},function(e){throw console.error(e.message),new Error("ZK preImage Error")}))}catch(e){return Promise.reject(e)}}generateZkProof(e,t){try{const n=this;return Promise.resolve(C(function(){const r=s.utils.defaultAbiCoder;return Promise.resolve(n.getProvider()).then(function(i){const s=t.params,a=t.preImage,u=parseInt(Math.round((new Date).getTime()/1e3).toString());return Promise.resolve(n.getNullifier(e)).then(function(t){return Promise.resolve(n.getZokrateProvider()).then(function(c){return Promise.resolve(n.getSource(n.rootFromPath,n.rootToPath)).then(function(l){return Promise.resolve(n.getArtifacts(l)).then(function(l){return Promise.resolve(i.getBlockNumber()).then(function(i){const p=n.buff2Hex(o(r.encode(["uint","uint","uint","string"],[t,u,i,e]))),y=[...s,...a],{witness:d}=c.computeWitness(l,y),m=c.setup(l.program),f=c.generateProof(l.program,d,m.pk),h=m.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(f),verifierKeyBuffer:JSON.stringify(h),nullifier:p}}})})})})})})},function(e){throw console.error(e.message),new Error("Generate zk proof error")}))}catch(e){return Promise.reject(e)}}verifyZkProof(e){try{const t=this;return Promise.resolve(C(function(){const n=e.verifierKeyBuffer,r=JSON.parse(e.proofBuffer),i=JSON.parse(n);return Promise.resolve(t.getZokrateProvider()).then(function(e){const t=e.verify(i,r);return t?{message:"Ok",isVerified:t}:{message:"invalid Proof Provided",isVerified:t}})},function(e){throw console.error(e.message),new Error("Verify Zk Proof error")}))}catch(e){return Promise.reject(e)}}}const F=[{inputs:[{internalType:"address",name:"_traceHub",type:"address"},{internalType:"address",name:"_traceAgreementImplementation",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"time",type:"uint256"},{indexed:!0,internalType:"address",name:"agreementAddress",type:"address"},{indexed:!0,internalType:"uint256",name:"id",type:"uint256"}],name:"AgreementCreated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"account",type:"address"},{indexed:!0,internalType:"address",name:"operator",type:"address"},{indexed:!1,internalType:"bool",name:"approved",type:"bool"}],name:"ApprovalForAll",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"operator",type:"address"},{indexed:!0,internalType:"address",name:"from",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256[]",name:"ids",type:"uint256[]"},{indexed:!1,internalType:"uint256[]",name:"values",type:"uint256[]"}],name:"TransferBatch",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"operator",type:"address"},{indexed:!0,internalType:"address",name:"from",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"id",type:"uint256"},{indexed:!1,internalType:"uint256",name:"value",type:"uint256"}],name:"TransferSingle",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"string",name:"value",type:"string"},{indexed:!0,internalType:"uint256",name:"id",type:"uint256"}],name:"URI",type:"event"},{inputs:[{internalType:"address",name:"account",type:"address"},{internalType:"uint256",name:"id",type:"uint256"}],name:"balanceOf",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address[]",name:"accounts",type:"address[]"},{internalType:"uint256[]",name:"ids",type:"uint256[]"}],name:"balanceOfBatch",outputs:[{internalType:"uint256[]",name:"",type:"uint256[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"},{internalType:"uint256",name:"id",type:"uint256"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"createInvoice",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"agreementAddress",type:"address"}],name:"getAgreementDetais",outputs:[{components:[{internalType:"bytes32",name:"verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"nullifiers",type:"bytes32[]"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"uint256",name:"agreementId",type:"uint256"}],internalType:"struct TraceAgreementFactory.TraceAgreementDetails",name:"",type:"tuple"}],stateMutability:"view",type:"function"},{inputs:[],name:"getFactoryAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"agreementAddress",type:"address"}],name:"getId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"id",type:"uint256"}],name:"getTraceAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"_verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"string",name:"enKey",type:"string"}],name:"initilizeAgreement",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"account",type:"address"},{internalType:"address",name:"operator",type:"address"}],name:"isApprovedForAll",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAdmin",type:"address"},{internalType:"address",name:"_supplier",type:"address"},{internalType:"uint256",name:"dataAvailiblity",type:"uint256"}],name:"newTraceAgreement",outputs:[{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256[]",name:"ids",type:"uint256[]"},{internalType:"uint256[]",name:"amounts",type:"uint256[]"},{internalType:"bytes",name:"data",type:"bytes"}],name:"safeBatchTransferFrom",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"id",type:"uint256"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bytes",name:"data",type:"bytes"}],name:"safeTransferFrom",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"operator",type:"address"},{internalType:"bool",name:"approved",type:"bool"}],name:"setApprovalForAll",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes4",name:"interfaceId",type:"bytes4"}],name:"supportsInterface",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[],name:"traceHub",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"tokenId",type:"uint256"}],name:"uri",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"}],_=[{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"newDefaultAdmin",type:"address"}],name:"DeafultAdminChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bool",name:"accepted",type:"bool"}],name:"ProposalAccepted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"bytes32",name:"previousAdminRole",type:"bytes32"},{indexed:!0,internalType:"bytes32",name:"newAdminRole",type:"bytes32"}],name:"RoleAdminChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"address",name:"account",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"}],name:"RoleGranted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"address",name:"account",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"}],name:"RoleRevoked",type:"event"},{inputs:[],name:"DEFAULT_ADMIN_ROLE",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[],name:"HUB_ADMIN",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"}],name:"acceptProposal",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceFactory",type:"address"}],name:"addFactory",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"newDeafultAdmin",type:"address"}],name:"changeDeafultAdmin",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"addr",type:"address"}],name:"checkDeafultAdmin",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],name:"checkHubAdmin",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"checkNullExist",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"checkNullLength",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"bytes32",name:"_nullifier",type:"bytes32"}],name:"checkNullifier",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"}],name:"checkSupplierApproved",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementDetails",outputs:[{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAgreementLog",outputs:[{components:[{internalType:"address",name:"traceAgreementContract",type:"address"},{internalType:"uint256",name:"id",type:"uint256"},{internalType:"uint256",name:"createdAt",type:"uint256"},{internalType:"string",name:"uri",type:"string"},{internalType:"bytes32[]",name:"nullifiers",type:"bytes32[]"},{internalType:"string",name:"encryptionKey",type:"string"}],internalType:"struct TraceHub.Agreement[]",name:"",type:"tuple[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementUri",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getEncryptionKey",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"}],name:"getRoleAdmin",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"id",type:"uint256"}],name:"getTraceAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],name:"grantAdminRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"grantRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"hasRole",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"initiateAgreement",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"addr",type:"address"}],name:"removeRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"renounceRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"revokeRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes4",name:"interfaceId",type:"bytes4"}],name:"supportsInterface",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"uint256",name:"id",type:"uint256"},{internalType:"string",name:"enKey",type:"string"}],name:"updatAgreementLog",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"string",name:"agreementUri",type:"string"}],name:"updatAgreementUri",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"bytes32",name:"_nullifier",type:"bytes32"}],name:"updateNullifier",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"zkProof",outputs:[],stateMutability:"nonpayable",type:"function"}],O=[{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"signCount",type:"uint256"},{indexed:!0,internalType:"bool",name:"verified",type:"bool"}],name:"Verified",type:"event"},{inputs:[],name:"activate",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAdmin",type:"address"},{internalType:"address",name:"_supplier",type:"address"},{internalType:"address",name:"_factoryAddress",type:"address"},{internalType:"address",name:"_traceHub",type:"address"},{internalType:"uint256",name:"_dataAvailibality",type:"uint256"}],name:"addTraceAdmin",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"checkIsInitilized",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[],name:"checkState",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAgreementId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAgreementUri",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"getDataAvailibality",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getEncryptionKey",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"getSupplier",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getTraceAdmin",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"_verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"string",name:"_agreementUri",type:"string"},{internalType:"string",name:"enKey",type:"string"}],name:"initilize",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"status",outputs:[{internalType:"enum TraceAgreement.AgreementStatus",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[],name:"traceHub",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"string",name:"_agreementUri",type:"string"}],name:"updateAgreementUri",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32[]",name:"_proof",type:"bytes32[]"},{internalType:"bytes32",name:"nullifier",type:"bytes32"},{internalType:"bytes32",name:"leaf",type:"bytes32"}],name:"verifyByOrder",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"}];function H(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}function N(e,t,n){if(!e.s){if(n instanceof R){if(!n.s)return void(n.o=N.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(N.bind(null,e,t),N.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}const R=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){const r=new e,i=this.s;if(i){const e=1&i?t:n;if(e){try{N(r,1,e(this.v))}catch(e){N(r,2,e)}return r}return this}return this.o=function(e){try{const i=e.v;1&e.s?N(r,1,t?t(i):i):n?N(r,1,n(i)):N(r,2,i)}catch(e){N(r,2,e)}},r},e}();class B extends I{createTraceAgreement(e,t,n,r){try{const i=this;return Promise.resolve(H(function(){return Promise.resolve(i.getFeeData()).then(function(o){const a=new s.Contract(i.getFactoryAddress(),F,r);let u=[];return Promise.resolve(a.newTraceAgreement(e,t,n,o)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1==e.status){for(let t of e.events)u.push(t.event);return Promise.resolve(e.events[0].args.agreementAddress).then(function(t){return Promise.resolve(e.events[0].args.id).then(function(n){return{message:"ok",transactionHash:e.transactionHash,details:{agreementAddress:t,agreementId:n.toString()}}})})}console.log("Creation Failed")})})})},function(e){throw console.error(e.message),new Error("Create Trace Agreement failed")}))}catch(e){return Promise.reject(e)}}acceptProposal(e,t){try{const n=this;return Promise.resolve(H(function(){return Promise.resolve(n.getFeeData()).then(function(r){let i=[];const o=new s.Contract(n.getTraceHubAddress(),_,t);return Promise.resolve(o.acceptProposal(e,r)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1==e.status){for(let t of e.events)i.push(t.event);return Promise.resolve(e.events[0].args.accepted)}console.log("verification failed")})})})},function(e){throw console.error(e.message),new Error("Accept proposal error")}))}catch(e){return Promise.reject(e)}}initilizeAgreement(e,t,n,r){try{const i=this;return Promise.resolve(H(function(){return Promise.resolve(i.getFeeData()).then(function(a){const u=[],c=s.utils.defaultAbiCoder;return Promise.resolve(i.getProvider()).then(function(l){const p=parseInt(Math.round((new Date).getTime()/1e3).toString());return Promise.resolve(l.getBlockNumber()).then(function(l){let y;const d=new s.Contract(t,O,r);return Promise.resolve(d.checkIsInitilized()).then(function(r){return 1==r?(console.log("Trace Agreement already initilized"),void(y=1)):Promise.resolve(d.getDataAvailibality()).then(function(r){return Promise.resolve(i.getVerifiersDetails(e)).then(function(s){const y=s.details,m=i.buff2Hex(o(c.encode(["uint","uint"],[p,l]))),f=T(m,32)();let h;return"1"===r.toString()?h=f:"2"===r.toString()&&(h=""),h=f,Promise.resolve(i.getPreImage(t)).then(function(r){const o=c.encode(["string"],[JSON.stringify(r)]);return Promise.resolve(i.encryptData({traceAddress:t,verifiersRoot:y.verifiersRoot,verifiers:e,txDetails:n,previousBlockCid:""},f)).then(function(n){return Promise.resolve(i.writeCar({encryptedData:n},t)).then(function(t){return Promise.resolve(d.initilize(y.verifiersRoot,y.nullifiers,t.cid,h,a)).then(function(n){return Promise.resolve(n.wait()).then(function(n){if(1==n.status){for(let t=0;t<e.length;t++)u.push({verifier:e[t],nullifier:y.nullifiers[t]});return{message:"ok",transactionHash:n.transactionHash,verificationDetails:u,packedProofDetails:o,encryptionKey:f,cid:t.cid}}console.log("initilization failed")})})})})})})})})})})})},function(e){throw console.error(e.message),new Error("Error Initilizing Agreement")}))}catch(e){return Promise.reject(e)}}createZkProof(e,t,n){try{const r=this;return Promise.resolve(H(function(){return Promise.resolve(r.getFeeData()).then(function(i){const o=s.utils.defaultAbiCoder.decode(["string"],t),a=JSON.parse(o[0]);return Promise.resolve(r.generateZkProof(e,a)).then(function(t){const o=new s.Contract(r.getTraceHubAddress(),_,n);return Promise.resolve(o.checkSupplierApproved(e)).then(function(n){if(n)return Promise.resolve(o.zkProof(e,t.details.nullifier,i)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1==e.status)return t.details;console.log("verification failed")})});console.log("Supplier has not approved")})})})},function(e){throw console.error(e.message),new Error("create ZK proof error")}))}catch(e){return Promise.reject(e)}}activateTraceAgreement(e,t,n){try{const r=this;return Promise.resolve(H(function(){return Promise.resolve(r.getFeeData()).then(function(i){const o=new s.Contract(r.getTraceHubAddress(),_,n);return Promise.resolve(o.checkNullExist(e,t.nullifier)).then(function(n){if(n)return Promise.resolve(r.verifyZkProof({proofBuffer:t.proofBuffer,verifierKeyBuffer:t.verifierKeyBuffer})).then(function(n){if("Ok"==n.message)return Promise.resolve(o.initiateAgreement(e,t.nullifier,i)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1==e.status)return{message:"ok",transactionHash:e.transactionHash};console.log("failed to initiate")})});console.log("Invalid ZK Proof Provided")});console.log("Invalid Nullifier")})})},function(e){throw console.error(e.message),new Error("Trace agreement activation error")}))}catch(e){return Promise.reject(e)}}verifyByOrder(e,t,n,r){try{const i=this;return Promise.resolve(H(function(){return Promise.resolve(i.getFeeData()).then(function(o){const a=new s.Contract(e,O,r);return Promise.resolve(a.getAgreementUri()).then(function(e){return Promise.resolve(i.decryptData(e,n)).then(function(e){return Promise.resolve(i.createProof(r.address,e.verifiers)).then(function(e){const n=i.getleave(r.address);let s=[];return Promise.resolve(a.verifyByOrder(e,t,n,o)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1==e.status){for(let t of e.events)s.push(t.event);return Promise.resolve(e.events[0].args.signCount).then(function(t){return Promise.resolve(e.events[0].args.verified).then(function(e){return{message:"ok",details:{verifiedCount:t,verified:e}}})})}console.log("verification failed")})})})})})})},function(e){throw console.error(e.message),new Error("ZKTrace Verification Error")}))}catch(e){return Promise.reject(e)}}getVerifiersDetails(e){try{const t=this;return Promise.resolve(H(function(){let n=[];const r=s.utils.defaultAbiCoder;return Promise.resolve(t.getMerkelTree(e)).then(function(i){let{root:s}=i;const a=parseInt(Math.round((new Date).getTime()/1e3).toString());return e.forEach(function(e){try{return Promise.resolve(t.getNullifier(e)).then(function(e){n.push(t.buff2Hex(o(r.encode(["uint","uint"],[e,a]))))})}catch(e){return Promise.reject(e)}}),{message:"ok",details:{verifiersRoot:s,nullifiers:n}}})},function(e){throw console.error(e.message),new Error("get verifier details error")}))}catch(e){return Promise.reject(e)}}encryptionDetails(e){try{const t=this;return Promise.resolve(H(function(){return Promise.resolve(t.getProvider()).then(function(t){const n=new s.Contract(e,O,t);return Promise.resolve(n.getEncryptionKey()).then(function(e){return Promise.resolve(n.getAgreementUri()).then(function(t){return{encryptionKey:e,cid:t}})})})},function(e){console.error(e.message)}))}catch(e){return Promise.reject(e)}}getVerifiersProof(e){try{const t=this;return Promise.resolve(H(function(){const n=[],r=(i=e,o=function(r){return Promise.resolve(t.createProof(e[r],e)).then(function(t){const i=e[r];return Promise.resolve(t).then(function(e){n.push({verifier:i,merkelProof:e})})})},u=-1,function e(t){try{for(;++u<i.length;)if((t=o(u))&&t.then){if(!((n=t)instanceof R&&1&n.s))return void t.then(e,a||(a=N.bind(null,s=new R,2)));t=t.v}s?N(s,1,t):s=t}catch(e){N(s||(s=new R),2,e)}var n}(),s);var i,o,s,a,u;return r&&r.then?r.then(function(){return n}):n},function(e){throw console.error(e.message),new Error("get verifier proof error")}))}catch(e){return Promise.reject(e)}}}class K extends B{}var U;U=K,[B].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(U.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})});export{K as default};
